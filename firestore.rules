rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Helper function to check user role
    function getUserRole() {
      return get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role;
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == "admin";
    }

    // Helper function to check if user is wholeseller
    function isWholeseller() {
      return isAuthenticated() && getUserRole() == "wholeseller";
    }

    // Helper function to validate profile data
    function isValidProfile(profile) {
      return profile.keys().hasAll(['id', 'email', 'role']) &&
             profile.id is string &&
             profile.email is string &&
             profile.role is string &&
             profile.role in ["customer", "wholeseller", "admin"];
    }

    // Helper function to validate order data
    function isValidOrder(order) {
      return order.keys().hasAll([
        'user_id', 'order_number', 'status', 'payment_status',
        'subtotal', 'total', 'currency', 'shipping_address', 'items'
      ]) &&
      order.user_id is string &&
      order.order_number is string &&
      order.status in ["pending", "confirmed", "processing", "shipped", "delivered", "cancelled", "refunded"] &&
      order.payment_status in ["pending", "paid", "failed", "refunded"] &&
      order.subtotal is number && order.subtotal >= 0 &&
      order.total is number && order.total >= 0 &&
      order.currency is string &&
      order.items is list && order.items.size() > 0;
    }

    // Profiles collection
    match /profiles/{userId} {
      // Users can read their own profile, admins can read all
      allow read: if isOwner(userId) || isAdmin();

      // Users can create their own profile with valid data
      // Designated admin email can create with admin role
      allow create: if isOwner(userId) &&
                       isValidProfile(request.resource.data) &&
                       (request.resource.data.role == "customer" ||
                        (request.auth.token.email == "z41d.706@gmail.com" && request.resource.data.role == "admin"));

      // Users can update their own profile (except role field)
      allow update: if isOwner(userId) &&
                       (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']));

      // Designated admin email can update their own role to admin
      allow update: if isOwner(userId) &&
                       request.auth.token.email == "z41d.706@gmail.com" &&
                       request.resource.data.role == "admin";

      // Admins can update any profile (for changing roles)
      allow update: if isAdmin();
    }

    // Categories collection
    match /categories/{categoryId} {
      // Anyone can read categories
      allow read: if true;

      // Admins can write
      allow create, update, delete: if isAdmin();
    }

    // Products collection
    match /products/{productId} {
      // Anyone can read products
      allow read: if true;

      // Admins can write
      allow create, update, delete: if isAdmin();
    }

    // User-specific cart items
    match /users/{userId}/cart/{itemId} {
      allow read, write: if isOwner(userId);
    }

    // User-specific wishlist items
    match /users/{userId}/wishlist/{itemId} {
      allow read, write: if isOwner(userId);
    }

    // Orders collection
    match /orders/{orderId} {
      // Users can read only their OWN orders, admins can read all
      allow read: if isAuthenticated() &&
                     (resource.data.user_id == request.auth.uid || isAdmin());

      // Users can create orders with valid data (only their own)
      allow create: if isAuthenticated() &&
                       request.resource.data.user_id == request.auth.uid &&
                       isValidOrder(request.resource.data);

      // Admins can update/delete orders
      allow update, delete: if isAdmin();
    }

    // Coupons collection
    match /coupons/{couponId} {
      // Anyone can read coupons
      allow read: if true;

      // Admins can manage coupons
      allow create, update, delete: if isAdmin();
    }

    // Site settings collection
    match /site_settings/{settingId} {
      // Anyone can read site settings
      allow read: if true;

      // Admins can manage site settings
      allow create, update, delete: if isAdmin();
    }

    // Item requests collection
    match /item_requests/{requestId} {
      // Users can read their own requests
      allow read: if isAuthenticated() &&
                     (resource.data.user_id == request.auth.uid || isAdmin());

      // Wholesellers can create requests (only their own)
      allow create: if isWholeseller() &&
                       request.resource.data.user_id == request.auth.uid &&
                       request.resource.data.keys().hasAll(['user_id', 'item_name']);

      // Users can delete their own pending requests
      allow delete: if isAuthenticated() &&
                       resource.data.user_id == request.auth.uid &&
                       resource.data.status == 'pending';

      // Admins can update/delete any request
      allow update, delete: if isAdmin();
    }
  }
}
